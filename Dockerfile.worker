FROM node@sha256:7378f5a4830ef48eb36d1abf4ef398391db562b5c41a0bded83192fbcea21cc8 AS builder

WORKDIR /app

# Enable pnpm via corepack
RUN corepack enable

# Minimal base hardening: ensure CA certs and clean apt cache
RUN apt-get update \
	&& apt-get install -y --no-install-recommends ca-certificates curl \
	&& rm -rf /var/lib/apt/lists/*

# Install deps (including dev deps to build TS)
COPY package.json pnpm-lock.yaml ./
RUN pnpm install --frozen-lockfile

# Copy source and build worker
COPY . .
RUN pnpm run build:worker

FROM node@sha256:7378f5a4830ef48eb36d1abf4ef398391db562b5c41a0bded83192fbcea21cc8 AS runtime
WORKDIR /app

# Enable pnpm via corepack
RUN corepack enable

# Minimal base hardening: ensure CA certs and clean apt cache
RUN apt-get update \
	&& apt-get install -y --no-install-recommends ca-certificates \
	&& rm -rf /var/lib/apt/lists/*

# Install only production deps
COPY package.json pnpm-lock.yaml ./
RUN pnpm install --frozen-lockfile --prod

# Copy compiled worker
COPY --from=builder /app/dist ./dist

ENV NODE_ENV=production

# Drop privileges for runtime
USER node

CMD ["node", "dist/scripts/agentWorker.js"]
